{% extends "base.html" %}

{% block title %}Statistiques - Restaurant Management{% endblock %}

{% block content %}
<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Statistiques</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}">Accueil</a></li>
                    <li class="breadcrumb-item active">Statistiques</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <!-- Small boxes (Stat box) -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>{{ ca_today }} FCFA</h3>
                        <p>CA Aujourd'hui</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-euro-sign"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>{{ ca_month }} FCFA</h3>
                        <p>CA Mois</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-calendar"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>{{ commandes_today }}</h3>
                        <p>Commandes Aujourd'hui</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3>{{ total_produits }}</h3>
                        <p>Produits Total</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-box"></i>
                    </div>
                </div>
            </div>
        </div>
        <!-- /.row -->

        <!-- Main row -->
        <div class="row">
            <!-- Left col -->
            <section class="col-lg-8 connectedSortable">
                <!-- Chart CA -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-line mr-1"></i>
                            Évolution des 7 derniers jours
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="evolutionChart" style="min-height: 250px; height: 250px;"></canvas>
                    </div>
                </div>

                <!-- Top produits -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-star mr-1"></i>
                            Top 10 Produits Vendus
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th>Produit</th>
                                        <th>Quantité Vendue</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for produit in top_produits %}
                                    <tr>
                                        <td>{{ produit.produit__nom }}</td>
                                        <td>{{ produit.total_vendu }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="2" class="text-center text-muted">Aucune vente enregistrée</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            <!-- /.col -->
            
            <!-- Right col -->
            <section class="col-lg-4 connectedSortable">
                <!-- Top catégories -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-pie mr-1"></i>
                            Top Catégories
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="categoriesChart" style="min-height: 200px; height: 200px;"></canvas>
                    </div>
                </div>

                <!-- Résumé -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-info-circle mr-1"></i>
                            Résumé
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="info-box mb-3 bg-light">
                            <span class="info-box-icon bg-info elevation-1">
                                <i class="fas fa-box"></i>
                            </span>
                            <div class="info-box-content">
                                <span class="info-box-text">Produits Actifs</span>
                                <span class="info-box-number">{{ produits_actifs }}</span>
                            </div>
                        </div>
                        <div class="info-box mb-3 bg-light">
                            <span class="info-box-icon bg-warning elevation-1">
                                <i class="fas fa-exclamation-triangle"></i>
                            </span>
                            <div class="info-box-content">
                                <span class="info-box-text">Produits en Rupture</span>
                                <span class="info-box-number">{{ produits_en_rupture }}</span>
                            </div>
                        </div>
                        <div class="info-box mb-3 bg-light">
                            <span class="info-box-icon bg-success elevation-1">
                                <i class="fas fa-tags"></i>
                            </span>
                            <div class="info-box-content">
                                <span class="info-box-text">Catégories</span>
                                <span class="info-box-number">{{ total_categories }}</span>
                            </div>
                        </div>
                        <div class="info-box mb-3 bg-light">
                            <span class="info-box-icon bg-primary elevation-1">
                                <i class="fas fa-users"></i>
                            </span>
                            <div class="info-box-content">
                                <span class="info-box-text">Clients Total</span>
                                <span class="info-box-number">{{ total_clients }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- /.col -->
        </div>
        <!-- /.row -->
    </div>
    <!-- /.container-fluid -->
</section>
<!-- /.content -->

<!-- ChartJS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(function () {
    // Préparer les données pour les graphiques
    var evolutionLabels = [];
    var evolutionData = [];
    {% for item in evolution_data %}
    evolutionLabels.push('{{ item.date }}');
    evolutionData.push({{ item.ca }});
    {% endfor %}
    
    var categoriesLabels = [];
    var categoriesData = [];
    {% for cat in top_categories %}
    categoriesLabels.push('{{ cat.produit__categorie__nom|default:"Non catégorisé" }}');
    categoriesData.push({{ cat.total_ca }});
    {% endfor %}
    
    // Chart évolution
    var evolutionCtx = document.getElementById('evolutionChart').getContext('2d')
    var evolutionChart = new Chart(evolutionCtx, {
        type: 'line',
        data: {
            labels: evolutionLabels,
            datasets: [{
                label: 'Chiffre d\'affaires (FCFA)',
                data: evolutionData,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    })

    // Chart catégories
    var categoriesCtx = document.getElementById('categoriesChart').getContext('2d')
    var categoriesChart = new Chart(categoriesCtx, {
        type: 'doughnut',
        data: {
            labels: categoriesLabels,
            datasets: [{
                data: categoriesData,
                backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    })
})
</script>
{% endblock %}
